#!/usr/bin/env python3
"""
USB Sentinel Notification Script

Called by udev to notify the daemon of device events.
Used for audit logging and event tracking.

Usage: usb-sentinel-notify <action> <kernel_name> [reason]

Actions:
    allow  - Device was allowed (fast-path whitelist)
    block  - Device was blocked (fast-path blacklist)
    remove - Device was removed
"""

from __future__ import annotations

import json
import os
import socket
import sys
import time
from pathlib import Path


# Configuration
SOCKET_PATH = "/var/run/usb-sentinel.sock"
TIMEOUT = 2.0  # Short timeout for notifications


def log(message: str) -> None:
    """Log message to syslog-compatible format."""
    print(f"usb-sentinel-notify: {message}", file=sys.stderr)


def send_notification(action: str, kernel_name: str, reason: str = "") -> bool:
    """
    Send notification to daemon.

    Args:
        action: Event action (allow, block, remove)
        kernel_name: Kernel device name
        reason: Optional reason for the action

    Returns:
        True if notification was sent successfully
    """
    if not Path(SOCKET_PATH).exists():
        # Daemon not running, skip silently
        return False

    try:
        sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
        sock.settimeout(TIMEOUT)
        sock.connect(SOCKET_PATH)

        # Send notification (fire and forget)
        notification = {
            "type": "notification",
            "action": action,
            "kernel_name": kernel_name,
            "reason": reason,
            "timestamp": time.time(),
            "source": "udev",
        }
        sock.sendall(json.dumps(notification).encode() + b"\n")
        sock.close()
        return True

    except (socket.timeout, socket.error):
        return False


def main() -> int:
    """Main entry point."""
    if len(sys.argv) < 3:
        print(f"Usage: {sys.argv[0]} <action> <kernel_name> [reason]", file=sys.stderr)
        return 1

    action = sys.argv[1]
    kernel_name = sys.argv[2]
    reason = sys.argv[3] if len(sys.argv) > 3 else ""

    if action not in ("allow", "block", "remove"):
        log(f"Unknown action: {action}")
        return 1

    # Send notification
    if send_notification(action, kernel_name, reason):
        log(f"Notified: {action} {kernel_name}")
    else:
        log(f"Could not notify daemon (not running?)")

    return 0


if __name__ == "__main__":
    sys.exit(main())
